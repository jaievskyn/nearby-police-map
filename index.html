<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nearby Police ‚Äì Map</title>
  <meta name="description" content="Shows your location and nearby police stations and recent public safety incidents using public data. Deployable on GitHub Pages.">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root{
      --bg:#0b0f14; --fg:#e6eef7; --muted:#a8b3c2; --accent:#63b3ed; --card:#11161d; --edge:#1a222d;
      --good:#7bd389; --warn:#f6c177; --bad:#ff6b6b;
    }
    html,body{height:100%}
    body{margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--fg);}
    #app{display:grid; grid-template-rows:auto 1fr auto; height:100%}
    header, footer{padding:10px 14px; background:var(--card); border-bottom:1px solid var(--edge)}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px}
    h1{margin:0; font-size:18px}
    .controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .btn{appearance:none; border:1px solid var(--edge); background:var(--card); color:var(--fg); padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:600}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .field{display:flex; align-items:center; gap:6px; font-size:14px; color:var(--muted)}
    input, select{background:var(--card); border:1px solid var(--edge); color:var(--fg); border-radius:10px; padding:6px 8px}
    #map{width:100%; height:100%}
    .legend{position:absolute; z-index:500; bottom:14px; left:14px; background:var(--card); border:1px solid var(--edge); border-radius:12px; padding:8px 10px; color:var(--muted); font-size:12px}
    a{color:var(--accent); text-decoration:none}
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>üó∫Ô∏è Nearby Police (Privacy‚Äësafe)</h1>
    <div class="controls">
      <button id="locate" class="btn">Use my location</button>
      <div class="field">Radius
        <select id="radius">
          <option value="2000">2 km</option>
          <option value="5000" selected>5 km</option>
          <option value="10000">10 km</option>
        </select>
      </div>
      <button id="refresh" class="btn" disabled>Refresh data</button>
    </div>
  </header>

  <div id="map"></div>

  <footer>
    <small>
      This demo shows nearby <strong>police stations</strong> (from OpenStreetMap) and optional <strong>recent public safety incidents</strong> from open data portals when configured.
      It does <em>not</em> track real‚Äëtime officer locations. Your location never leaves the browser.
      Tiles ¬© <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OSM</a>.
    </small>
  </footer>

  <div class="legend" id="legend">
    <div>üõ°Ô∏è Police stations</div>
    <div>‚ö†Ô∏è Incidents (last 24h, if configured)</div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(() => {
  // =======================
  // Configuration
  // =======================
  // Optional: If your city publishes 911/incident data via a Socrata open data portal,
  // enter the details below to enable incident markers. Some examples:
  //  - Seattle: domain "data.seattle.gov", dataset "kdmc-wqbf" (Police 911 calls)
  //  - San Francisco: domain "data.sfgov.org", dataset "wg3w-h783" (Police incidents)
  // Check your city's open data site for docs and dataset IDs. Rate limits apply.
  const INCIDENTS = {
    enabled: false,          // set to true after filling out fields
    domain: "",              // e.g., "data.seattle.gov"
    dataset: "",             // e.g., "kdmc-wqbf"
    appToken: "",           // optional Socrata app token for higher limits
    categoryField: "",      // e.g., "event_clearance_group" or "incident_category"
    timeField: "",          // ISO date field name for filtering last 24h
    descriptionFields: []    // array of fields to show in popup
  };

  // =======================
  // Map setup
  // =======================
  const map = L.map('map', { zoomControl: true });
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  const userMarker = L.circleMarker([0,0], { radius: 8, weight:2, color:'#63b3ed', fillColor:'#63b3ed', fillOpacity:0.5 });
  const stationLayer = L.layerGroup().addTo(map);
  const incidentLayer = L.layerGroup().addTo(map);

  const locateBtn = document.getElementById('locate');
  const refreshBtn = document.getElementById('refresh');
  const radiusSel = document.getElementById('radius');

  locateBtn.addEventListener('click', getLocation);
  refreshBtn.addEventListener('click', () => refreshData(lastPos));

  let lastPos = null;

  async function getLocation(){
    locateBtn.disabled = true;
    locateBtn.textContent = 'Locating‚Ä¶';
    try{
      const pos = await new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('Geolocation unsupported'));
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true, timeout: 15000, maximumAge: 0
        });
      });
      const { latitude: lat, longitude: lon } = pos.coords;
      lastPos = { lat, lon };
      map.setView([lat, lon], 14);
      userMarker.setLatLng([lat, lon]).addTo(map).bindPopup('You are here');
      refreshBtn.disabled = false;
      await refreshData({ lat, lon });
    }catch(err){
      alert('Could not get your location: ' + err.message + '\nTip: Use HTTPS and allow location access.');
    }finally{
      locateBtn.textContent = 'Use my location';
      locateBtn.disabled = false;
    }
  }

  async function refreshData(center){
    stationLayer.clearLayers();
    incidentLayer.clearLayers();
    const r = parseInt(radiusSel.value, 10);
    if (!center) return;
    await Promise.all([
      loadStations(center, r),
      INCIDENTS.enabled ? loadIncidents(center, r) : Promise.resolve()
    ]);
  }

  // =======================
  // Load police stations (OpenStreetMap via Overpass API)
  // =======================
  async function loadStations(center, radius){
    const { lat, lon } = center;
    const query = `\n      [out:json][timeout:25];\n      (\n        node["amenity"="police"](around:${radius},${lat},${lon});\n        way["amenity"="police"](around:${radius},${lat},${lon});\n        relation["amenity"="police"](around:${radius},${lat},${lon});\n      );\n      out center;\n    `;
    try{
      const res = await fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: new URLSearchParams({ data: query })
      });
      if (!res.ok) throw new Error('Overpass error ' + res.status);
      const json = await res.json();
      json.elements.forEach(el => {
        const lat = el.lat || (el.center && el.center.lat);
        const lon = el.lon || (el.center && el.center.lon);
        if (lat==null || lon==null) return;
        const tags = el.tags || {};
        const name = tags.name || 'Police facility';
        const addr = [tags['addr:housenumber'], tags['addr:street'], tags['addr:city']].filter(Boolean).join(' ');
        const popup = `<strong>üõ°Ô∏è ${escapeHtml(name)}</strong><br>${escapeHtml(addr)}<br>` +
                      (tags.phone ? `‚òéÔ∏è ${escapeHtml(tags.phone)}<br>` : '') +
                      (tags.website ? `<a href="${escapeAttr(tags.website)}" target="_blank" rel="noopener">Website</a>` : '');
        L.marker([lat, lon]).addTo(stationLayer).bindPopup(popup);
      });
    }catch(err){
      console.error(err);
      alert('Could not load nearby stations (Overpass). Try again later.');
    }
  }

  // =======================
  // Optional: Load recent incidents from a Socrata open data portal
  // =======================
  async function loadIncidents(center, radius){
    if (!INCIDENTS.enabled) return;
    const { lat, lon } = center;
    const kilometers = radius / 1000;
    const since = new Date(Date.now() - 24*3600*1000).toISOString();

    const base = `https://${INCIDENTS.domain}/resource/${INCIDENTS.dataset}.json`;
    const params = new URLSearchParams();
    // Select fields (include location field as the last one, common names: location, point, geometry)
    // We will try to infer the location field from common names.
    const where = [
      INCIDENTS.timeField ? `${INCIDENTS.timeField} >= '${since}'` : '1=1',
      INCIDENTS.categoryField ? `${INCIDENTS.categoryField} IS NOT NULL` : '1=1'
    ].join(' AND ');

    params.set('$where', where + ` AND within_circle(location, ${lat}, ${lon}, ${radius})`);
    params.set('$limit', '200');
    if (INCIDENTS.appToken) params.set('$$app_token', INCIDENTS.appToken);

    try{
      const res = await fetch(`${base}?${params.toString()}`);
      if (!res.ok) throw new Error('Incidents API error ' + res.status);
      const rows = await res.json();
      rows.forEach(r => {
        const loc = r.location || r.point || r.geometry;
        const coords = loc && (loc.coordinates || (loc.latitude && loc.longitude && [loc.longitude, loc.latitude]));
        if (!coords || coords.length < 2) return;
        const [lng, lat] = coords;
        const descParts = [];
        INCIDENTS.descriptionFields.forEach(f => { if (r[f]) descParts.push(`<div>${escapeHtml(f)}: ${escapeHtml(String(r[f]))}</div>`); });
        L.marker([lat, lng], { icon: L.divIcon({ className: 'incident', html: '‚ö†Ô∏è', iconSize: [16,16], iconAnchor:[8,8] }) })
          .addTo(incidentLayer)
          .bindPopup(`<strong>‚ö†Ô∏è Incident</strong>${descParts.join('')}`);
      });
    }catch(err){
      console.error(err);
      alert('Could not load incidents. Check configuration or rate limits.');
    }
  }

  // =======================
  // Utils
  // =======================
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }
  function escapeAttr(s){
    return String(s).replace(/"/g, '&quot;');
  }

  // Center the map somewhere sensible initially
  map.setView([37.77397, -122.43129], 12);
})();
</script>
</body>
</html>
